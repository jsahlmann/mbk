# 07 - MMRM Mixed model repeated measures 

## Data

Source of data: SPR, an R package to simulate clinical data as part of training in R statistical programming.

https://cjangelo.github.io/SPR/index.html

Data generated by the program in https://cjangelo.github.io/SPR/articles/a08_Fit_MMRM_in_R.html

Dataset df07.csv


```R
library(readr)
df07 <- read_csv("data/df07.csv",
                 show_col_types = FALSE)
head(df07)

```


<table class="dataframe">
<caption>A tibble: 6 × 7</caption>
<thead>
	<tr><th scope=col>USUBJID</th><th scope=col>Group</th><th scope=col>Time</th><th scope=col>Y_comp</th><th scope=col>XB</th><th scope=col>error</th><th scope=col>Y_mar</th></tr>
	<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th></tr>
</thead>
<tbody>
	<tr><td>Subject_0001</td><td>Group_1</td><td>Time_1</td><td>-0.07673563</td><td>0</td><td>-0.07673563</td><td>-0.0767356342764288</td></tr>
	<tr><td>Subject_0002</td><td>Group_2</td><td>Time_1</td><td>-0.41197323</td><td>0</td><td>-0.41197323</td><td>-0.411973233779806 </td></tr>
	<tr><td>Subject_0003</td><td>Group_1</td><td>Time_1</td><td>-1.22969052</td><td>0</td><td>-1.22969052</td><td>-1.22969052255179  </td></tr>
	<tr><td>Subject_0004</td><td>Group_2</td><td>Time_1</td><td> 0.03483386</td><td>0</td><td> 0.03483386</td><td>0.0348338577296185 </td></tr>
	<tr><td>Subject_0005</td><td>Group_1</td><td>Time_1</td><td> 0.51250275</td><td>0</td><td> 0.51250275</td><td>0.512502751066066  </td></tr>
	<tr><td>Subject_0006</td><td>Group_2</td><td>Time_1</td><td> 0.23896566</td><td>0</td><td> 0.23896566</td><td>0.238965657323612  </td></tr>
</tbody>
</table>



## SAS program snippet

The following SAS code will be executed.
proc mixed data=df07 method=reml covtest;
   class Group (Ref = "Group_1") Time (Ref = "Time_1") USUBJID;
   model Y_comp = Group Time Group*Time / s;
   repeated / type=un subject=USUBJID r;
run;

## Results

The output is divided into blocks to explain it and to reproduce it afterwards in the different languages.

### Block 1
![Block 1](img_screenshots/block_101.png)

This block gives information about the model.

### R chunk for reproduction

The first chunk uses nlme::gls.



```R
library(SPR)
library(MASS)
library(glmmTMB) # https://cran.r-project.org/web/packages/glmmTMB/vignettes/covstruct.html
library(emmeans)
library(nlme)
library(lme4)
library(broom)
my_gls <- nlme::gls(Y_comp ~ Group + Time + Group*Time,
                       data = df07,
                       correlation = corSymm(form = ~ 1 | USUBJID),    #  unstructured correlation
                       weights = varIdent(form = ~ 1 | Time),          #  freely estimate variance at subsequent timepoints
                       na.action = na.exclude)
summary(my_gls)
```


    Generalized least squares fit by REML
      Model: Y_comp ~ Group + Time + Group * Time 
      Data: df07 
         AIC      BIC    logLik
      1036.4 1107.883 -500.2002
    
    Correlation Structure: General
     Formula: ~1 | USUBJID 
     Parameter estimate(s):
     Correlation: 
      1     2     3    
    2 0.779            
    3 0.574 0.728      
    4 0.484 0.535 0.763
    Variance function:
     Structure: Different standard deviations per stratum
     Formula: ~1 | Time 
     Parameter estimates:
      Time_1   Time_2   Time_3   Time_4 
    1.000000 1.095606 1.217203 1.499564 
    
    Coefficients:
                                 Value  Std.Error    t-value p-value
    (Intercept)             -0.0693893 0.13692310 -0.5067758  0.6126
    GroupGroup_2             0.3336959 0.19363850  1.7232931  0.0856
    TimeTime_2              -0.0531747 0.09614668 -0.5530579  0.5805
    TimeTime_3               0.0054841 0.14258851  0.0384609  0.9693
    TimeTime_4              -0.0566736 0.18351241 -0.3088272  0.7576
    GroupGroup_2:TimeTime_2  0.0280852 0.13597194  0.2065512  0.8365
    GroupGroup_2:TimeTime_3 -0.1262152 0.20165061 -0.6259106  0.5317
    GroupGroup_2:TimeTime_4 -0.1468045 0.25952574 -0.5656646  0.5719
    
     Correlation: 
                            (Intr) GrpG_2 TmTm_2 TmTm_3 TmTm_4 GG_2:TT_2 GG_2:TT_3
    GroupGroup_2            -0.707                                                
    TimeTime_2              -0.208  0.147                                         
    TimeTime_3              -0.289  0.205  0.573                                  
    TimeTime_4              -0.204  0.144  0.317  0.694                           
    GroupGroup_2:TimeTime_2  0.147 -0.208 -0.707 -0.405 -0.224                    
    GroupGroup_2:TimeTime_3  0.205 -0.289 -0.405 -0.707 -0.491  0.573             
    GroupGroup_2:TimeTime_4  0.144 -0.204 -0.224 -0.491 -0.707  0.317     0.694   
    
    Standardized residuals:
            Min          Q1         Med          Q3         Max 
    -2.55759465 -0.68545835 -0.02754474  0.67478149  2.54110499 
    
    Residual standard error: 0.9681925 
    Degrees of freedom: 400 total; 392 residual


The second chunk uses mmrm().

mmrm need categorical variables as factors.


```R
library(mmrm)
df08 <- df07
df08$Group_fct <- as.factor(df08$Group)
df08$Time_fct <- as.factor(df08$Time)
my_mmrm <- mmrm(
  formula = Y_comp ~ Group_fct + Time_fct + Group_fct*Time_fct + us(Time_fct | USUBJID),
  data = df08
)
summary(my_mmrm)
```


    mmrm fit
    
    Formula:     
    Y_comp ~ Group_fct + Time_fct + Group_fct * Time_fct + us(Time_fct |  
        USUBJID)
    Data:        df08 (used 400 observations from 100 subjects with maximum 4 
    timepoints)
    Covariance:  unstructured (10 variance parameters)
    Method:      Satterthwaite
    Inference:   REML
    
    Model selection criteria:
         AIC      BIC   logLik deviance 
      1020.4   1046.5   -500.2   1000.4 
    
    Coefficients: 
                                     Estimate Std. Error        df t value Pr(>|t|)
    (Intercept)                     -0.069389   0.136924 98.010000  -0.507    0.613
    Group_fctGroup_2                 0.333696   0.193640 98.010000   1.723    0.088
    Time_fctTime_2                  -0.053175   0.096145 98.010000  -0.553    0.581
    Time_fctTime_3                   0.005484   0.142592 98.000000   0.038    0.969
    Time_fctTime_4                  -0.056674   0.183520 97.990000  -0.309    0.758
    Group_fctGroup_2:Time_fctTime_2  0.028085   0.135969 98.010000   0.207    0.837
    Group_fctGroup_2:Time_fctTime_3 -0.126215   0.201656 98.000000  -0.626    0.533
    Group_fctGroup_2:Time_fctTime_4 -0.146805   0.259536 97.990000  -0.566    0.573
                                     
    (Intercept)                      
    Group_fctGroup_2                .
    Time_fctTime_2                   
    Time_fctTime_3                   
    Time_fctTime_4                   
    Group_fctGroup_2:Time_fctTime_2  
    Group_fctGroup_2:Time_fctTime_3  
    Group_fctGroup_2:Time_fctTime_4  
    ---
    Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    
    Covariance estimate:
           Time_1 Time_2 Time_3 Time_4
    Time_1 0.9374 0.8001 0.6548 0.6807
    Time_2 0.8001 1.1251 0.9104 0.8234
    Time_3 0.6548 0.9104 1.3888 1.3058
    Time_4 0.6807 0.8234 1.3058 2.1080
    


### Block 2
![Block 2](img_screenshots/block_102.png)

This block gives the level for the categorical variables.

The right section of the screenshot was removed to fit this page.

### R chunk for reproction


```R
table(df07$Group)
table(df07$Time)
head(table(df07$USUBJID))
```


    
    Group_1 Group_2 
        200     200 



    
    Time_1 Time_2 Time_3 Time_4 
       100    100    100    100 



    
    Subject_0001 Subject_0002 Subject_0003 Subject_0004 Subject_0005 Subject_0006 
               4            4            4            4            4            4 


### Block 3
![Block 3](img_screenshots/block_103.png)

This block gives information about the number of subjects and the maximal number of observations per subject.

### R chunk for reproduction



```R
suppressPackageStartupMessages(library(tidyverse))
print("Subjects:")
df07 %>% select(USUBJID) %>% unique() %>% count(name = "Subjects") %>% pull(Subjects)
print("Max Obs per Subject")
df07 %>% select(USUBJID, Time) %>% group_by(USUBJID) %>%
summarize(MaxSubObs = n()) %>% 
ungroup() %>%
summarize(MaxObs = max(MaxSubObs)) %>%
pull(MaxObs)
```

    [1] "Subjects:"
    


100


    [1] "Max Obs per Subject"
    


4


### Block 4
![Block 4](img_screenshots/block_104.png)

The number of observations used might be less than the number of observations read. SAS performs a listwise deletion (complete case analysis) if missing values are present.

# Todo: Complete the following cells

### R chunk for reproduction



```R

```

### Block 5
![Block 5](img_screenshots/block_105.png)

This block gives information about the iteration process.

### R chunk for reproduction



```R

```

### Block 6
![Block 6](img_screenshots/block_106.png)

This block informs about the status of the iterative estimation process at the end of the Newton-Raphson optimization.

### R chunk for reproduction


```R

```

### Block 7
![Block 7](img_screenshots/block_107.png)

Details for this block can be found in the SAS Proc MIXED manuals in Mixed Models Theory.

### R chunk for reproduction



```R

```

### Block 8
![Block 8](img_screenshots/block_108.png)

This block gives statistics about the estimated mixed models.

### R chunk for reproduction




```R

```

### Block 9
![Block 9](img_screenshots/block_109.png)

This block gives the likelihood ratio test for the null model.

### R chunk for reproduction



```R

```

### Block 10
![Block 10](img_screenshots/block_110.png)

This block provides the estimates for the fixed effects of the model.

### R chunk for reproduction




```R
data.frame("estimates" = my_gls$coeff)
```


<table class="dataframe">
<caption>A data.frame: 8 × 1</caption>
<thead>
	<tr><th></th><th scope=col>estimates</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>(Intercept)</th><td>-0.069389313</td></tr>
	<tr><th scope=row>GroupGroup_2</th><td> 0.333695897</td></tr>
	<tr><th scope=row>TimeTime_2</th><td>-0.053174683</td></tr>
	<tr><th scope=row>TimeTime_3</th><td> 0.005484079</td></tr>
	<tr><th scope=row>TimeTime_4</th><td>-0.056673629</td></tr>
	<tr><th scope=row>GroupGroup_2:TimeTime_2</th><td> 0.028085170</td></tr>
	<tr><th scope=row>GroupGroup_2:TimeTime_3</th><td>-0.126215247</td></tr>
	<tr><th scope=row>GroupGroup_2:TimeTime_4</th><td>-0.146804525</td></tr>
</tbody>
</table>



### Block 11
![Block 11](img_screenshots/block_111.png)

This block contains hypothesis tests for the significance of each of the fixed effects.

### R chunk for reproduction


```R

```
